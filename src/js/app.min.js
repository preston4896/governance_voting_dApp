class App extends React.Component{async loadWeb3(){if(window.ethereum)window.web3=new Web3(window.ethereum),await window.ethereum.enable();else if(window.web3)window.web3=new Web3(window.web3.currentProvider);else{confirm("Browser does not support Web3. Consider installing MetaMask.")&&window.open("https://metamask.io/","_blank","noopener, noreferrer")}}async loadContract(){this.setState({loading:!0}),this.setState({contractDeployed:!1});const e=window.web3,t=await e.eth.net.getId();let a,n;this.setState({network:t}),await fetch("./src/builds/Vote.json").then((e=>e.json())).then((s=>{a=s.abi,n=s.networks[t].address;const o=new e.eth.Contract(a,n);this.setState({voteContract:o}),this.setState({contractDeployed:!0})})).catch((e=>{window.alert("The contract is not deployed to this network.")})),await this.loadData(),this.setState({loading:!1})}async loadData(){const e=this.state.voteContract,t=window.web3,a=await t.eth.getAccounts();this.setState({account:a[0]});let n=await t.eth.getBalance(this.state.account),s=t.utils.fromWei(n,"ether");this.setState({accountBalance:s});const o=await e.methods.get_staked().call({from:this.state.account}),l=t.utils.fromWei(o,"ether");this.setState({amountDeposited:l});const r=await e.methods.get_withdraw().call({from:this.state.account}),i=t.utils.fromWei(r,"ether");this.setState({amountWithdrawable:i})}async getCurrentBlockNumber(){const e=await window.web3.eth.getBlockNumber();this.setState({currentBlockNumber:e})}constructor(e){super(e),this.state={account:"0x0",accountBalance:"0",amountDeposited:"0",amountWithdrawable:"0",network:"-1",currentBlockNumber:"0",voteContract:{},contractDeployed:!1,loading:!0},this.loadWeb3=this.loadWeb3.bind(this),this.loadContract=this.loadContract.bind(this),this.loadData=this.loadData.bind(this)}render(){let e,t,a=React.createElement("p",null," © 2021 Copyrights Reserved by Preston Ong ");return this.state.loading?e=React.createElement("p",null," Loading... "):(this.state.contractDeployed&&(t=React.createElement("div",null,React.createElement("div",{className:"row"},React.createElement("div",{className:"col"}," ",React.createElement("p",null," Total net debited: ",this.state.amountDeposited," ETH ")," "),React.createElement("div",{className:"col"}," ",React.createElement("p",null," Withdrawable amount: ",this.state.amountWithdrawable," ETH "),"  ")),React.createElement("p",null," A minimum of 0.001 ETH is required to create a new proposal. "),React.createElement(AppBody,{contract:this.state.voteContract,refresh:this.loadData})),a=React.createElement("footer",null,React.createElement("div",{className:"container"},React.createElement("div",{className:"row"},React.createElement("div",{className:"col"}," ",React.createElement("p",null," Current Block Number: ",this.state.currentBlockNumber," ")," "))))),e=React.createElement("div",{className:"container"},React.createElement("h2",null," Welcome, ",this.state.account,"! "),React.createElement("h3",null," Your current balance is ",this.state.accountBalance," ETH "))),React.createElement("div",{className:"container text-center text-break"},React.createElement("h1",null," Preston's Voting dApp "),e,t,a)}async componentDidMount(){await this.loadWeb3(),await this.loadContract(),await window.ethereum.on("chainChanged",(()=>{this.loadContract()})),await window.ethereum.on("accountsChanged",(()=>{this.loadData()}))}async componentDidUpdate(){await this.getCurrentBlockNumber()}}class AppBody extends React.Component{async loadPropCount(e){const t=this.props.contract,a=(await window.web3.eth.getAccounts())[0];let n;return n=e?await t.methods.myProposal_count(a).call():await t.methods.total_proposals().call(),n}constructor(e){super(e),this.state={componentState:"home",bodyLoading:!1,transactionFailed:!1,anyProp:!0,propCount:0,newTitle:"",newOffset:"",amount:"0.001"},this.propHandler=this.propHandler.bind(this),this.propOwnHandler=this.propOwnHandler.bind(this),this.backHandler=this.backHandler.bind(this),this.createHandler=this.createHandler.bind(this),this.titleHandler=this.titleHandler.bind(this),this.offsetHandler=this.offsetHandler.bind(this),this.depositHandler=this.depositHandler.bind(this),this.submitHandler=this.submitHandler.bind(this),this.redeemHandler=this.redeemHandler.bind(this),this.withdrawHandler=this.withdrawHandler.bind(this),this.throwTransactionFailed=this.throwTransactionFailed.bind(this),this.home=this.home.bind(this)}async propHandler(){this.setState({bodyLoading:!0});let e=await this.loadPropCount(!1);this.setState({propCount:e}),this.setState({componentState:"prop"}),this.setState({anyProp:!0}),this.setState({bodyLoading:!1}),await this.props.refresh()}async propOwnHandler(){this.setState({bodyLoading:!0});let e=await this.loadPropCount(!0);this.setState({propCount:e}),this.setState({componentState:"prop"}),this.setState({anyProp:!1}),this.setState({bodyLoading:!1}),await this.props.refresh()}async createHandler(){this.setState({bodyLoading:!0}),this.setState({componentState:"create"}),this.setState({bodyLoading:!1}),await this.props.refresh()}async backHandler(){this.setState({transactionFailed:!1}),this.setState({componentState:"home"}),await this.props.refresh()}titleHandler(e){this.setState({newTitle:e.target.value})}offsetHandler(e){this.setState({newOffset:e.target.value})}depositHandler(e){this.setState({amount:e.target.value})}async submitHandler(){if(""!==this.state.newTitle&&""!==this.state.newOffset&&parseFloat(this.state.amount)>=.001){this.setState({bodyLoading:!0});const e=(await window.web3.eth.getAccounts())[0],t=this.props.contract,a=await window.web3.eth.getBalance(e),n=web3.utils.toWei(this.state.amount.toString(),"ether");if(a<n)window.alert("Insufficient balance.");else try{await t.methods.create(this.state.newTitle,this.state.newOffset).send({from:e,value:n}).on("transactionHash",(e=>{this.setState({newTitle:""}),this.setState({newOffset:""}),this.setState({amount:"0.001"}),this.setState({componentState:"home"}),this.props.refresh(),window.alert("Your Proposal Has Been Successfully Created.")})).on("error",(e=>{this.setState({transactionFailed:!0}),console.error("Transaction failed (Preston)",e)}))}catch(e){this.setState({transactionFailed:!0}),console.error("Rejection hurts (Preston)",e)}this.setState({bodyLoading:!1})}}async redeemHandler(){this.setState({bodyLoading:!0});const e=await this.loadPropCount(!0);let t;if(0==e&&(t=window.confirm("You have not created or voted on any proposals yet. It is unlikely that you would have accrued any redeemable ETH. Proceeding this option will incur a transaction (gas) fee. Continue?")),!1===t&&(this.setState({bodyLoading:!1}),this.setState({componentState:"home"})),e>0||t){const e=this.props.contract,t=(await window.web3.eth.getAccounts())[0];try{await e.methods.updateEthEarned().send({from:t}).on("transactionHash",(e=>{window.alert("Your transaction has been confirmed.")})).on("error",(e=>{this.setState({transactionFailed:!0}),console.error("Transaction failed (Preston)",e)}))}catch(e){this.setState({transactionFailed:!0}),console.error("Rejection hurts (Preston)",e)}this.setState({bodyLoading:!1}),this.setState({componentState:"home"}),await this.props.refresh()}}async withdrawHandler(){this.setState({bodyLoading:!0}),window.alert("Make sure that you clicked on Redeem ETH to claim all of your withdrawable ETH before withdrawing.");const e=this.props.contract,t=(await window.web3.eth.getAccounts())[0];if(0==await e.methods.get_withdraw().call({from:t}))window.alert("You do not have any withdrawable ETH.");else try{await e.methods.withdrawEth().send({from:t}).on("transactionHash",(e=>{window.alert("Funds have been withdrawned.")})).on("error",(e=>{this.setState({transactionFailed:!0}),console.error("Transaction failed (Preston)",e)}))}catch(e){this.setState({transactionFailed:!0}),console.error("Rejection hurts (Preston)",e)}this.setState({bodyLoading:!1}),this.setState({componentState:"home"}),await this.props.refresh()}throwTransactionFailed(){this.setState({transactionFailed:!0})}home(){this.setState({componentState:"home"})}render(){let e;if(this.state.bodyLoading)e=React.createElement("p",null," Loading... ");else if(this.state.transactionFailed)e=React.createElement("div",{className:"container"},React.createElement("p",null," Error: The transaction did not go through. Please try again. "),React.createElement(BackButton,{handler:this.backHandler}));else if("home"==this.state.componentState)e=React.createElement("div",{className:"row d-flex align-items-center justify-content-between"},React.createElement("div",{className:"row-sm-12 rol-md-6 rol-lg-2"}," ",React.createElement("button",{title:"Locate A Proposal By Their IDs.",onClick:this.propHandler}," Search or Vote On Proposal(s) ")," "),React.createElement("div",{className:"row-sm-12 rol-md-6 rol-lg-2"}," ",React.createElement("button",{title:"View The Proposals That You Created.",onClick:this.propOwnHandler}," Find My Proposals ")," "),React.createElement("div",{className:"row-sm-12 rol-md-6 rol-lg-2"}," ",React.createElement("button",{title:"A minimum of 0.001 ETH is required.",onClick:this.createHandler}," Create A Proposal and Stake ETH ")," "),React.createElement("div",{className:"row-sm-12 rol-md-6 rol-lg-2"}," ",React.createElement("button",{title:"Redeem Your Total Withdrawable ETH Amount.",onClick:this.redeemHandler}," Redeem ETH ")," "),React.createElement("div",{className:"row-sm-12 rol-md-6 rol-lg-2"}," ",React.createElement("button",{title:"Withdraw all ETH to your wallet. Make sure to redeem withdrawable ETH first.",onClick:this.withdrawHandler}," Withdraw ETH ")," "));else if("prop"==this.state.componentState){let t;t=this.state.anyProp?React.createElement("div",{className:"container"},React.createElement("p",null," Proposal Count: ",this.state.propCount," ")):React.createElement("div",{className:"container"},React.createElement("p",null," You have created or voted on ",this.state.propCount," proposal(s) so far. ")),e=React.createElement("div",{className:"container"},t,React.createElement(ViewPropComponent,{isAny:this.state.anyProp,contract:this.props.contract,err:this.throwTransactionFailed}),React.createElement(BackButton,{handler:this.backHandler}))}else"create"==this.state.componentState&&(e=React.createElement("div",{className:"container"},React.createElement("div",{className:"col",style:{margin:"10px",border:"dashed black"}},React.createElement("p",null," New Proposal "),React.createElement("div",{className:"row"},React.createElement("label",null,"Title:",React.createElement("input",{type:"text",style:{margin:"3px"},value:this.state.newTitle,onChange:this.titleHandler}))),React.createElement("div",{className:"row"},React.createElement("label",null,"End Block Number Offset:",React.createElement("input",{type:"number",min:"1",style:{margin:"3px"},value:this.state.newOffset,onChange:this.offsetHandler}))),React.createElement("div",{className:"row"},React.createElement("label",null,"Deposit Amount:",React.createElement("input",{type:"number",min:"0.001",style:{margin:"3px"},value:this.state.amount,onChange:this.depositHandler}))),React.createElement("button",{onClick:this.submitHandler}," Submit ")),React.createElement("p",null," An average block time is approximately 10-20 seconds (Mainnet, Rinkeby and Goerli). An offset of 1 would mean that your proposal would only last for 20 seconds at most. "),React.createElement("p",{style:{fontStyle:"strong",color:"red"}}," WARNING: You must deposit more than 0.001 ETH, otherwise the transaction will fail. "),React.createElement(BackButton,{handler:this.backHandler})));return React.createElement("div",{className:"container"},e)}}function BackButton(e){return React.createElement("button",{onClick:e.handler}," Back ")}class ViewPropComponent extends React.Component{async loadProposal(e,t){const a=this.props.contract,n=await window.web3.eth.getAccounts();let s=new Array(9);t&&e--;try{s=await a.methods.get_proposals(e,t).call({from:n[0]})}catch(e){window.alert("Unable to load proposal.")}return{id:s[0],proposer:s[1],title:s[2],yay_count:window.web3.utils.fromWei(s[3].toString(),"ether"),nay_count:window.web3.utils.fromWei(s[4].toString(),"ether"),total_deposit:window.web3.utils.fromWei(s[5].toString(),"ether"),begin_block_number:s[6],end_block_number:s[7],max_deposit:window.web3.utils.fromWei(s[8].toString(),"ether")}}async fetchVote(e){const t=this.props.contract,a=(await window.web3.eth.getAccounts())[0];return await t.methods.get_votes(e).call({from:a})}constructor(e){super(e),this.state={proposal:void 0,input:"",voted:"",currentBlockNumber:"",yaySelected:!1,naySelected:!1,ethDeposited:"0",voteCasted:!1},this.inputHandler=this.inputHandler.bind(this),this.voteHandler=this.voteHandler.bind(this),this.depositHandler=this.depositHandler.bind(this),this.submitVoteHandler=this.submitVoteHandler.bind(this)}async inputHandler(e){""!==e.target.value&&0!==e.target.value||this.setState({proposal:void 0}),this.setState({input:e.target.value})}voteHandler(e){"Yay"===e.target.value&&e.target.checked?(this.setState({yaySelected:!0}),this.setState({naySelected:!1})):"Nay"===e.target.value&&e.target.checked&&(this.setState({yaySelected:!1}),this.setState({naySelected:!0}))}depositHandler(e){this.setState({ethDeposited:e.target.value})}async submitVoteHandler(){const e=this.props.contract,t=(await window.web3.eth.getAccounts())[0],a=await window.web3.eth.getBalance(t),n=window.web3.utils.fromWei(a,"ether"),s=this.state.ethDeposited,o=window.web3.utils.toWei(s.toString(),"ether"),l=!(this.state.yaySelected&&this.state.naySelected)&&(this.state.yaySelected||this.state.naySelected),r=this.state.yaySelected&&!this.state.naySelected;if(l)if(0==s)window.alert("Deposit amount can not be zero.");else if(s>this.state.proposal.max_deposit)window.alert("Deposit amount exceeded allowance.");else if(s>parseFloat(n))window.alert("Your balance is insufficient.");else try{await e.methods.vote(this.state.proposal.id,r).send({from:t,value:o}).on("transactionHash",(e=>{window.alert("Vote casted successfully."),this.setState({voteCasted:!0})})).on("error",(e=>{this.props.err(),console.error("Transaction failed (Preston)",e)}))}catch(e){this.props.err(),console.error("Rejection hurts (Preston)",e)}else window.alert("Vote or die.")}render(){let e,t;if(this.state.proposal){let e,a=React.createElement("div",{className:"content"},"  ");const n=this.state.proposal.end_block_number>this.state.currentBlockNumber;if("0"===this.state.voted?e=n?React.createElement("div",{className:"container",style:{border:"groove blue",padding:"10px"}},React.createElement("div",{className:"col text-center"},React.createElement("p",null," Cast Your Vote: "),React.createElement("div",{className:"row"},React.createElement("div",{className:"col"}," ",React.createElement("label",null," ",React.createElement("input",{type:"radio",value:"Yay",checked:this.state.yaySelected,onChange:this.voteHandler})," YAY ")," "),React.createElement("div",{className:"col"}," ",React.createElement("label",null," ",React.createElement("input",{type:"radio",value:"Nay",checked:this.state.naySelected,onChange:this.voteHandler})," NAY ")," ")),React.createElement("div",{className:"row"},React.createElement("div",{className:"col"}," Deposit Amount:  "),React.createElement("div",{className:"col"}," ",React.createElement("input",{type:"number",value:this.state.ethDeposited,onChange:this.depositHandler})," "),React.createElement("div",{className:"col"}," ",React.createElement("button",{onClick:this.submitVoteHandler}," VOTE ✔ ")," ")))):React.createElement("p",null," You can no longer vote for this proposal. "):"1"===this.state.voted?e=React.createElement("div",null," You voted: ",React.createElement("p",{style:{color:"green"}}," YAY ")," "):"2"===this.state.voted&&(e=React.createElement("div",null," You voted: ",React.createElement("p",{style:{color:"red"}}," NAY ")," ")),!n){let e;e=this.state.proposal.yay_count>this.state.proposal.nay_count?React.createElement("h3",null," The proposal ended with the ",React.createElement("p",{style:{fontWeight:"bold",color:"green"}}," YAYs ")," as the majority. "):this.state.proposal.yay_count<this.state.proposal.nay_count?React.createElement("h3",null," The proposal ended with the ",React.createElement("p",{style:{fontWeight:"bold",color:"red"}}," NAYs ")," as the majority. "):React.createElement("h2",null," The proposal ended with a ",React.createElement("p",{style:{fontWeight:"bold",color:"yellow"}}," TIE "),". "),a=React.createElement("div",{className:"container"},e)}let s=100*this.state.proposal.yay_count/this.state.proposal.total_deposit,o=100*this.state.proposal.nay_count/this.state.proposal.total_deposit;t=React.createElement("div",{className:"container"},React.createElement("p",{style:{fontWeight:"bold"}}," Proposal ID #",this.state.proposal.id," "),React.createElement("div",{className:"col"},React.createElement("div",{className:"row"},React.createElement("div",{className:"col"}," ",React.createElement("h1",null," ",this.state.proposal.title," ")," ")),React.createElement("div",{className:"row"},React.createElement("div",{className:"col"}," ",React.createElement("label",null," Proposer:  ")," "),React.createElement("div",{className:"col"}," ",React.createElement("p",null," ",this.state.proposal.proposer," "))),React.createElement("div",{className:"row"},React.createElement("div",{className:"col"}," ",React.createElement("label",null," Total ETH Staked:  ")," "),React.createElement("div",{className:"col"}," ",React.createElement("p",null," ",this.state.proposal.total_deposit," ETH ")," ")),React.createElement("div",{className:"row"},React.createElement("div",{className:"col"}," ",React.createElement("label",null," Maximum ETH Voting Allowance:  ")," "),React.createElement("div",{className:"col"}," ",React.createElement("p",null," ",this.state.proposal.max_deposit," ETH ")," ")),React.createElement("div",{className:"row"},React.createElement("div",{className:"col"}," ",React.createElement("label",null," Yay %:  ")," "),React.createElement("div",{className:"col"}," ",React.createElement("p",{style:{color:"green"}}," ",s.toFixed(2)," % "),"  ")),React.createElement("div",{className:"row"},React.createElement("div",{className:"col"}," ",React.createElement("label",null," Nay %:  ")," "),React.createElement("div",{className:"col"}," ",React.createElement("p",{style:{color:"red"}}," ",o.toFixed(2)," % "),"  ")),React.createElement("div",{className:"row"},React.createElement("div",{className:"col"}," ",React.createElement("label",null," Begin Block Number:  ")," "),React.createElement("div",{className:"col"}," ",React.createElement("p",null," ",this.state.proposal.begin_block_number," ")," ")),React.createElement("div",{className:"row"},React.createElement("div",{className:"col"}," ",React.createElement("label",null," End Block Number:  ")," "),React.createElement("div",{className:"col"}," ",React.createElement("p",null," ",this.state.proposal.end_block_number," ")," "))),e,a)}else t=React.createElement("div",{className:"container"},React.createElement("p",null," Waiting to fetch proposal... "));return e=this.props.isAny?React.createElement("div",{className:"container-fluid"},React.createElement("div",{className:"row"},React.createElement("div",{className:"col"},React.createElement("input",{placeholder:"Enter Proposal ID",type:"number",value:this.state.input,onChange:this.inputHandler}))),t):React.createElement("div",{className:"container-fluid"},React.createElement("div",{className:"row"},React.createElement("div",{className:"col"},React.createElement("input",{placeholder:"Enter Index Number",type:"number",value:this.state.input,onChange:this.inputHandler}))),t),React.createElement("div",{className:"container",style:{border:"dotted black",margin:"10px"}},e)}async componentDidUpdate(e,t){let a=!this.props.isAny;if(t.input!==this.state.input&&""!==this.state.input&&"0"!==this.state.input||t.voteCasted!==this.state.voteCasted){const e=await this.loadProposal(this.state.input,a),t=await this.fetchVote(this.state.input),n=await window.web3.eth.getBlockNumber();this.setState({proposal:e}),this.setState({voted:t}),this.setState({currentBlockNumber:n})}}}ReactDOM.render(React.createElement(App,null),document.getElementById("root"));